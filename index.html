<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Pontos</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: sans-serif;
      background-color: #e8f0fe;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .filtros input[type="text"],
    .filtros input[type="date"],
    .filtros input[type="month"] {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 200px;
    }

    .filtros button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background-color: #4285f4;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .filtros button:hover {
      background-color: #3367d6;
    }

    .acoes-barra {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 25px;
    }

    .acoes-barra a,
    .acoes-barra button {
      text-decoration: none;
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border-radius: 6px;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .acoes-barra a:hover,
    .acoes-barra button:hover {
      background-color: #3367d6;
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-box {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
    }

    .autocomplete-box div {
      padding: 8px;
      cursor: pointer;
    }

    .autocomplete-box div:hover {
      background-color: #f1f1f1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    /* ===== Popup de Edição de Ponto ===== */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100;
}

.popup {
  background: white;
  padding: 20px 25px;
  border-radius: 10px;
  width: 320px;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  text-align: center;
}

.popup h3 {
  margin-top: 0;
  color: #003366;
}

.popup input {
  width: 90%;
  padding: 8px;
  margin-top: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  text-align: center;
}

.popup .botoes {
  margin-top: 15px;
  display: flex;
  justify-content: space-around;
}

.popup button {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

.popup .salvar {
  background-color: #4caf50;
  color: white;
}

.popup .excluir {
  background-color: #e53935;
  color: white;
}

.popup .cancelar {
  background-color: #ccc;
}

  </style>
</head>
<body>
  <div class="container">
    <h1>Painel Administrativo</h1>

    <div class="filtros">
      <div class="autocomplete-container">
        <input
          type="text"
          id="buscaFuncionario"
          placeholder="Buscar por nome ou CPF"
          autocomplete="off"
        />
        <div id="sugestoes" class="autocomplete-box"></div>
      </div>

      <input type="date" id="filtroData" />
      <input type="month" id="filtroMes" />
      <button onclick="buscarPontos()">Buscar</button>
    </div>

    <!-- Opções administrativas abaixo da pesquisa -->
    <div class="acoes-barra">
      <a href="cadastrar.html">Cadastrar Funcionário</a>
      <a href="editar.html">Editar Funcionário</a>
      <a href="excluir.html">Excluir Funcionário</a>
      <a href="editar-ponto.html">Editar Ponto</a>
      <a href="adicionar-ponto.html">Adicionar Ponto</a>
      <button onclick="exportarPDF()">Exportar PDF</button>
    </div>

    <table id="tabelaPontos">
  <thead>
    <tr>
      <th colspan="5" id="nomeFuncionario">Funcionário: -</th>
      <th colspan="7" id="nomeFuncionario">Funcionário: -</th>
    </tr>
    <tr>
      <th>Data</th>
      <th>Entrada (Manhã)</th>
      <th>Saída (Almoço)</th>
      <th>Retorno (Almoço)</th>
      <th>Saída (Tarde)</th>
      <th>Horas Trabalhadas</th>
      <th>Horas Extras</th>
    </tr>
  </thead>
  <tbody>
    <!-- Linhas de ponto serão adicionadas aqui -->
    
    <!-- Linha de assinatura -->
    <tr>
      <td colspan="7" style="text-align: center; padding-top: 40px;">
        <div style="border-top: 1px solid #000; width: 300px; margin: 0 auto;"></div>
        <span>Assinatura do Funcionário</span>
      </td>
    </tr>
  </tbody>
</table>

<!-- Bibliotecas jsPDF e AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

let funcionarioSelecionado = null;

const buscaFuncionario = document.getElementById("buscaFuncionario");
const sugestoes = document.getElementById("sugestoes");

buscaFuncionario.addEventListener("input", async (e) => {
  const valor = e.target.value.trim();
  sugestoes.innerHTML = "";

  if (valor.length === 0) return;

  try {
    // Consulta no Firestore buscando por nome ou CPF que contenha o texto digitado
    const colRef = collection(db, "funcionarios");
    const q = query(colRef,
      where("cpf", ">=", valor),
      where("cpf", "<=", valor + "\uf8ff")
    );
    const snap = await getDocs(q);

    snap.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.textContent = `${data.nome} - ${data.cpf}`;
      div.style.cursor = "pointer";
      div.style.padding = "4px 8px";
      div.style.borderBottom = "1px solid #ddd";

      div.onclick = () => {
        buscaFuncionario.value = data.nome;
        funcionarioSelecionado = data.cpf;
        sugestoes.innerHTML = "";
      };

      sugestoes.appendChild(div);
    });

    if (snap.empty) {
      const div = document.createElement("div");
      div.textContent = "Nenhum funcionário encontrado";
      div.style.padding = "4px 8px";
      sugestoes.appendChild(div);
    }

  } catch (err) {
    console.error("Erro ao buscar funcionários:", err);
  }
});

  function calcularHoras(inicio, fim) {
    if (!inicio || !fim) return 0;
    const [h1, m1] = inicio.split(":").map(Number);
    const [h2, m2] = fim.split(":").map(Number);
    return (h2*60 + m2 - (h1*60 + m1)) / 60;
  }

  function buscarPontos() {
    const tbody = document.querySelector("#tabelaPontos tbody");
    tbody.innerHTML = "";

    const pontos = [
      {data:"2025-08-01", entrada:"08:00", almocoSaida:"12:00", almocoRetorno:"13:00", saida:"17:30"},
      {data:"2025-08-02", entrada:"08:15", almocoSaida:"12:05", almocoRetorno:"13:00", saida:"18:20"},
      {data:"2025-08-03", entrada:"08:10", almocoSaida:"12:00", almocoRetorno:"13:15", saida:"17:00"}
    ];

    pontos.forEach(p => {
      const horasManha = calcularHoras(p.entrada, p.almocoSaida);
      const horasTarde = calcularHoras(p.almocoRetorno, p.saida);
      const totalDia = horasManha + horasTarde;
      const extras = totalDia > 8 ? totalDia - 8 : 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.data}</td>
        <td data-tipo="entrada">${p.entrada}</td>
        <td data-tipo="almocoSaida">${p.almocoSaida}</td>
        <td data-tipo="almocoRetorno">${p.almocoRetorno}</td>
        <td data-tipo="saida">${p.saida}</td>
        <td>${totalDia.toFixed(2)}</td>
        <td>${extras.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    const assinatura = document.createElement("tr");
    assinatura.innerHTML = `
      <td colspan="7" style="text-align:center; padding-top:40px;">
        <div style="border-top:1px solid #000; width:300px; margin:0 auto;"></div>
        <span>Assinatura do Funcionário</span>
      </td>
    `;
    tbody.appendChild(assinatura);
  }

  async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tabela = document.querySelector("#tabelaPontos");
    const linhas = [];
    let totalHoras = 0;
    let totalExtras = 0;

    tabela.querySelectorAll("tbody tr:not(:last-child)").forEach(tr => {
      const tds = tr.querySelectorAll("td");
      const linha = Array.from(tds).map(td => td.textContent);
      linhas.push(linha);

      totalHoras += parseFloat(tds[5]?.textContent) || 0;
      totalExtras += parseFloat(tds[6]?.textContent) || 0;
    });

    const larguraPagina = doc.internal.pageSize.getWidth();
    doc.setFontSize(14);
    doc.text("Relatório de Pontos", larguraPagina/2, 20, { align:"center" });

    doc.autoTable({
      head: [['Data','Entrada','Saída Almoço','Retorno','Saída','Horas Trabalhadas','Horas Extras']],
      body: linhas,
      startY: 30,
      theme: 'grid'
    });

    const yFinal = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 50;
    doc.setFontSize(12);
    doc.text(`Total de Horas Trabalhadas no Mês: ${totalHoras.toFixed(2)}h`, 14, yFinal);
    doc.text(`Total de Horas Extras no Mês: ${totalExtras.toFixed(2)}h`, 14, yFinal + 10);

    const yLinha = yFinal + 40;
    const margem = 40;
    const larguraLinha = larguraPagina - margem*2;
    doc.setLineWidth(0.5);
    doc.line(margem, yLinha, margem+larguraLinha, yLinha);
    doc.text("Assinatura do Funcionário", larguraPagina/2, yLinha+8, { align:"center" });

    doc.save("relatorio-pontos.pdf");
  }

  document.addEventListener("click", async (e) => {
    if (e.target.tagName === "TD" && !e.target.closest("thead")) {
      const tr = e.target.closest("tr");
      dataSelecionada = tr.children[0].textContent.trim();
      tipoSelecionado = e.target.dataset.tipo;
      celulaSelecionada = e.target;

      let valor = e.target.textContent.trim();
      if(valor && /^\d{2}:\d{2}$/.test(valor)) valor += ":00";
      campoValor.value = valor;
      document.getElementById("popupTitulo").textContent = valor ? "Editar Ponto" : "Adicionar Ponto";

      const q = query(collection(db,"pontos"),
                      where("cpf","==",funcionarioSelecionado),
                      where("data","==",dataSelecionada),
                      where("tipo","==",tipoSelecionado));
      const snap = await getDocs(q);
      docIdSelecionado = snap.empty ? null : snap.docs[0].id;

      popupOverlay.style.display = "flex";
    }
  });

  function fecharPopup() {
    popupOverlay.style.display = "none";
    celulaSelecionada = null;
  }

  async function salvarAlteracao() {
    const novoValor = campoValor.value.trim();
    if(!novoValor || !funcionarioSelecionado) {
      alert("Dados inválidos ou funcionário não selecionado!");
      return;
    }

    try {
      const colRef = collection(db, "pontos");
      if(docIdSelecionado) {
        const docRef = doc(db,"pontos",docIdSelecionado);
        await updateDoc(docRef, { hora: novoValor });
      } else {
        await addDoc(colRef, { cpf: funcionarioSelecionado, data: dataSelecionada, tipo: tipoSelecionado, hora: novoValor });
      }
      celulaSelecionada.textContent = novoValor;
      alert("Ponto salvo com sucesso!");
      fecharPopup();
    } catch(e) {
      console.error("Erro ao salvar:", e);
      alert("Erro ao salvar ponto.");
    }
  }

  async function excluirCelula() {
    if(!celulaSelecionada || !confirm("Deseja excluir este horário?")) return;
    try {
      if(docIdSelecionado) await deleteDoc(doc(db,"pontos",docIdSelecionado));
      celulaSelecionada.textContent = "";
      alert("Ponto excluído com sucesso!");
      fecharPopup();
    } catch(e) {
      console.error("Erro ao excluir:", e);
      alert("Erro ao excluir ponto.");
    }
  }
</script>

<!-- Popup para Adicionar / Editar / Excluir -->
<div id="popupOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:300px; text-align:center;">
    <h3 id="popupTitulo">Editar Ponto</h3>
    <input type="time" id="campoValor" step="1" style="width:100%; padding:8px; font-size:16px; margin-bottom:10px;">
    <div>
      <button id="btnSalvar" style="padding:8px 12px; margin:5px;">Salvar</button>
      <button id="btnExcluir" style="padding:8px 12px; margin:5px;">Excluir</button>
      <button id="btnFechar" style="padding:8px 12px; margin:5px;">Cancelar</button>
    </div>
  </div>
</div>


</body>
</html>













