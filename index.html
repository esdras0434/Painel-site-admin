<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Pontos</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: sans-serif;
      background-color: #e8f0fe;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #003366;
      margin-bottom: 25px;
    }
    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .filtros input[type="text"],
    .filtros input[type="month"] {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 200px;
    }
    .filtros button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background-color: #4285f4;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .filtros button:hover {
      background-color: #3367d6;
    }
    .acoes-barra {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 25px;
    }
    .acoes-barra a,
    .acoes-barra button {
      text-decoration: none;
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border-radius: 6px;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .acoes-barra a:hover,
    .acoes-barra button:hover {
      background-color: #3367d6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Painel Administrativo</h1>

    <div class="filtros">
      <input type="text" id="buscaFuncionario" placeholder="Buscar por CPF" />
      <input type="month" id="filtroMes" />
      <button onclick="buscarPontos()">Buscar</button>
    </div>

    <div class="acoes-barra">
      <a href="cadastrar.html">Cadastrar Funcionário</a>
      <a href="editar.html">Editar Funcionário</a>
      <a href="excluir.html">Excluir Funcionário</a>
      <a href="editar-ponto.html">Editar Ponto</a>
      <a href="adicionar-ponto.html">Adicionar Ponto</a>
      <button onclick="exportarPDF()">Exportar PDF</button>
    </div>

    <table id="tabelaPontos">
      <thead>
        <tr>
          <th colspan="7" id="nomeFuncionario">Funcionário: -</th>
        </tr>
        <tr>
          <th>Data</th>
          <th>Entrada (Manhã)</th>
          <th>Saída (Almoço)</th>
          <th>Retorno (Almoço)</th>
          <th>Saída (Tarde)</th>
          <th>Horas Trabalhadas</th>
          <th>Horas Extras</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase Modular v9+ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuCbBesvbrOvdzdv1cmCF7M2uaaUfWRU0",
      authDomain: "meupontoapp-d5d3b.firebaseapp.com",
      databaseURL: "https://meupontoapp-d5d3b-default-rtdb.firebaseio.com",
      projectId: "meupontoapp-d5d3b",
      storageBucket: "meupontoapp-d5d3b.firebasestorage.app",
      messagingSenderId: "700159340275",
      appId: "1:700159340275:web:51094e94b4159521cf5186",
      measurementId: "G-1TX8XYMSVK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function calcularHoras(inicio, fim) {
      if (!inicio || !fim) return 0;
      const [h1, m1] = inicio.split(":").map(Number);
      const [h2, m2] = fim.split(":").map(Number);
      return (h2 * 60 + m2 - (h1 * 60 + m1)) / 60;
    }

    let dadosTabela = [];
    let funcionarioSelecionado = "";

    window.buscarPontos = async function () {
      const cpf = document.getElementById("buscaFuncionario").value.trim();
      const mes = document.getElementById("filtroMes").value;
      if (!cpf || !mes) {
        alert("Digite o CPF e selecione o mês!");
        return;
      }

      funcionarioSelecionado = cpf;
      document.getElementById("nomeFuncionario").innerText = "Funcionário (CPF): " + cpf;

      const tbody = document.querySelector("#tabelaPontos tbody");
      tbody.innerHTML = "";
      dadosTabela = [];

      const [ano, mesNum] = mes.split("-");
      const inicioMes = new Date(ano, mesNum - 1, 1);
      const fimMes = new Date(ano, mesNum, 0);

      // Tentativa com Timestamp
      let q = query(
        collection(db, "pontos"),
        where("cpf", "==", cpf),
        where("data", ">=", Timestamp.fromDate(inicioMes)),
        where("data", "<=", Timestamp.fromDate(fimMes)),
        orderBy("data", "asc")
      );

      let snapshot = await getDocs(q);

      // Se não encontrar nada, tenta como string
      if (snapshot.empty) {
        const dataInicio = `${ano}-${String(mesNum).padStart(2, '0')}-01`;
        const dataFim = `${ano}-${String(mesNum).padStart(2, '0')}-${String(fimMes.getDate()).padStart(2, '0')}`;
        q = query(
          collection(db, "pontos"),
          where("cpf", "==", cpf),
          where("data", ">=", dataInicio),
          where("data", "<=", dataFim),
          orderBy("data", "asc")
        );
        snapshot = await getDocs(q);
      }

      snapshot.forEach(docSnap => {
        const p = docSnap.data();

        // Ajusta formato da data
        let dataFormatada;
        if (p.data instanceof Timestamp) {
          const d = p.data.toDate();
          dataFormatada = d.toISOString().split("T")[0];
        } else {
          dataFormatada = p.data;
        }

        const horasManha = calcularHoras(p.entrada, p.saidaAlmoco);
        const horasTarde = calcularHoras(p.retornoAlmoco, p.saida);
        const totalDia = horasManha + horasTarde;
        const extras = totalDia > 8 ? totalDia - 8 : 0;

        const linha = {
          data: dataFormatada,
          entrada: p.entrada || "-",
          almocoSaida: p.saidaAlmoco || "-",
          almocoRetorno: p.retornoAlmoco || "-",
          saida: p.saida || "-",
          horas: totalDia.toFixed(2),
          extras: extras.toFixed(2)
        };

        dadosTabela.push(linha);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${linha.data}</td>
          <td>${linha.entrada}</td>
          <td>${linha.almocoSaida}</td>
          <td>${linha.almocoRetorno}</td>
          <td>${linha.saida}</td>
          <td>${linha.horas}</td>
          <td>${linha.extras}</td>
        `;
        tbody.appendChild(tr);
      });
    };

    window.exportarPDF = async function () {
      if (dadosTabela.length === 0) {
        alert("Nenhum dado para exportar!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let totalHoras = 0;
      let totalExtras = 0;

      const linhas = dadosTabela.map(l => {
        totalHoras += parseFloat(l.horas);
        totalExtras += parseFloat(l.extras);
        return [l.data, l.entrada, l.almocoSaida, l.almocoRetorno, l.saida, l.horas, l.extras];
      });

      doc.setFontSize(14);
      doc.text("Relatório de Pontos", 14, 20);
      doc.text("Funcionário (CPF): " + funcionarioSelecionado, 14, 28);

      doc.autoTable({
        head: [['Data','Entrada','Saída Almoço','Retorno','Saída','Horas Trabalhadas','Horas Extras']],
        body: [
          ...linhas,
          ["", "", "", "", "TOTAL", totalHoras.toFixed(2), totalExtras.toFixed(2)]
        ],
        startY: 35
      });

      const yFinal = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12);
      doc.text(`Total de Horas Trabalhadas no Mês: ${totalHoras.toFixed(2)}h`, 14, yFinal);
      doc.text(`Total de Horas Extras no Mês: ${totalExtras.toFixed(2)}h`, 14, yFinal + 10);

      doc.line(14, yFinal + 40, 100, yFinal + 40);
      doc.text("Assinatura do Funcionário", 14, yFinal + 48);

      doc.save(`relatorio-${funcionarioSelecionado}.pdf`);
    };
  </script>
</body>
</html>
